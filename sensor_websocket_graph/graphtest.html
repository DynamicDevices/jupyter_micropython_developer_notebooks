<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Raphaël · Animated Chart</title>
<style media="screen">
body { background: #333; color: #fff;  }
#holder {
    position: absolute; 
    left: 0; 
    top: 0;
    margin: 0 0 0 0;
    width: 100%;
    height: 100%; 
    border: thin blue solid;
}
#controls { bottom: 0; right: 0; position: absolute; }
#controls input[type="button"] { border: 6px; font-size: 150% }
#channelselect { font-size: 150% }
#controls input[type="button"]:hover { background-color: yellow }
#controls input[type="text"] { border: 2px; width: 50px }
#response { background-color: #880; }


</style>
<script src="raphael.min.js"></script>
<script>

// the raphael canvas
var paper = null; 
var width = 900;  
var height = 200; 

var expscaleperunit = 0.05; 
var bpause = false; 

// class for a single time sequence
function TimeSeq(wsurl) {
    this.timeseq = [ ];
    this.maxtimeseq = 0; 
    this.mintimeseq = 0; 
    this.labmax = null; 
    this.labmin = null; 
    this.clr = Raphael.getColor(1);
    
    this.c = paper.path("M0,0").attr({fill: "none", "stroke-width": 2, "stroke-linecap": "round"}); 
    this.bg = paper.path("M0,0").attr({stroke: "none", opacity: .3}); 
    
    this.labmin = paper.text(0,0, "0.0").attr({"font-size":20, fill:"cyan"}); 
    this.labmax = paper.text(0,100, "1.0").attr({"font-size":20, fill:"cyan"}); 
    this.Dsimulatedsetinterval = null; 

    if (wsurl !== null) {
        this.ws = this.setupws(wsurl); 
    } else {
        this.ws = null; 
    }
}

TimeSeq.prototype.addtimeseq = function(v) {
    if ((this.timeseq.length == 0) || (v > this.maxtimeseq)) {
        this.maxtimeseq = v; 
        if (this.labmax !== null)
            this.labmax.attr("text", this.maxtimeseq.toFixed(2)); 
    }
    if ((this.timeseq.length == 0) || (v < this.mintimeseq)) {
        this.mintimeseq = v; 
        if (this.labmin !== null)
            this.labmin.attr("text", this.mintimeseq.toFixed(2)); 
    }
    this.timeseq.push(v); 
}

TimeSeq.prototype.cleartimeseq = function() {
    this.timeseq = [ ]; 
}
TimeSeq.prototype.removefronttimeseqs = function(n) {
    ltimeseq = this.timeseq; 
    this.cleartimeseq(); 
    for (var i = n; i < ltimeseq.length; i++)
        this.addtimeseq(ltimeseq[i]); 
    console.log("remove", n);
}
TimeSeq.prototype.gettimeseqval = function(i) {
    var d = (this.maxtimeseq - this.mintimeseq); 
    return (d != 0 ? 1-(this.timeseq[i] - this.mintimeseq)/d : 0); 
}

TimeSeq.prototype.makerpath = function() {
    var yoff = 10; 
    var hoff = height - 50; 
    var woff = 10, wmarg = 20; 
    var path = ["M", woff, Math.round(this.gettimeseqval(this.timeseq.length-1)*hoff+yoff), "L"]; 
    var gx = 1.0; 
    var i;
    for (i = this.timeseq.length - 2; i >= 0; i--) {
        gx *= (1-expscaleperunit); // exponential approach right hand side
        var x = width-woff-Math.round(gx*(width-woff*2)); 
        path.push(x); 
        path.push(Math.round(this.gettimeseqval(i)*height)); 
        if (x > width - wmarg)
            break; 
    }
    if (i > 20) 
        this.removefronttimeseqs(i); 

    if (this.c) 
        this.c.attr({path: path, stroke: this.clr});
    if (this.bg) 
        this.bg.attr({path: path + "V"+height+"H10z", fill: this.clr});
}

TimeSeq.prototype.setupws = function(wsurl) {
    this.ws.send(document.getElementById('lolz').value);
}
TimeSeq.prototype.kill = function() {
    if (this.ws) {
        this.ws.onerror = null; 
        this.ws.close(); 
    }
    if (this.c)
        this.c.remove(); 
    if(this.bg)
        this.bg.remove(); 
    if (this.labmin)
        this.labmin.remove(); 
    if (this.labmax)
        this.labmax.remove();
    if (this.Dsimulatedsetinterval !== null)
        clearInterval(this.Dsimulatedsetinterval); 
}

TimeSeq.prototype.setupws = function(wsurl) {
    var ws = new WebSocket(wsurl);
    ws.onerror = function(e) { 
        console.log(e);  alert("websocket no good"); 
    };
    ws.onopen = function() { ws.send("Hello"); };
    
    var tthis = this; 
    ws.onmessage = function(evt) {
        console.log(evt); 
        bb = evt; 
        if (typeof evt.data === "string") {   // encoding values into ascii
            // we can accept multiple numbers in a batch (2bytes decodes to 0<4096) but print the message if out of range
            var nums = [ ]; 
            for (var i = 1; i < evt.data.length; i += 2) {
                var b0 = evt.data.charCodeAt(i-1)-0x30; 
                var b1 = evt.data.charCodeAt(i)-0x30; 
                if ((0 <= b0) && (b0 <= 0x3F) && (0 <= b1) && (b1 <= 0x3F))
                    nums.push(b0 + (b1<<6)); 
                else {
                    nums = null; 
                    break
                }
            }
            if ((nums !== null) && !bpause) {
                document.getElementById("responsenumbers").innerHTML = nums.join(" "); 
                for (var i = 0; i < nums.length; i++)
                    tthis.addtimeseq(nums[i]);
                tthis.makerpath();
            } else {
                document.getElementById("response").innerHTML = evt.data; 
            }
        };
    }
    return ws; 
}



Raphael.getColor(1); // lose the red first colour
var ts = null; 

function setupraph() {
    window.addEventListener("resize", setraphsize);
    document.getElementById("channelselect").addEventListener("change", setwschannel); 

    var rholder = document.getElementById("holder"); 
    width = rholder.offsetWidth; 
    height = rholder.offsetHeight; 
    paper = Raphael("holder", width, height); 

    setwschannel(); 
}

function setwschannel(wschannel) {
    var wschannel = document.getElementById("channelselect").value; 
    if (ts !== null) {
        ts.kill(); 
        ts = null; 
    }
    wsurl = null; 
    if (location.hostname)
        wsurl = "ws://" + location.hostname + "/" + wschannel + (location.port ? ":" + location.port : ""); 
    ts = new TimeSeq(wsurl); 
    if (wsurl === null)
        ts.Dsimulatedsetinterval = setInterval(function() { ts.addtimeseq(Math.random()*0.3);  ts.makerpath(); }, 200); 
    setraphsize(); 
}

function setraphsize() {
    var rholder = document.getElementById("holder"); 
    width = rholder.offsetWidth; 
    height = rholder.offsetHeight; 
    paper.setSize(width, height); 

    var yoff = 10; 
    var hoff = height - 50; 
    ts.labmin.attr({x:30, y:yoff+hoff}); 
    ts.labmax.attr({x:30, y:yoff+20}); 
}

Raphael(setupraph); 
</script>
</head>
<body>

<div id="holder"></div>

<div id="controls">
    <span id="response">(ws received)</span>
    <span id="responsenumbers"></span>
    <input type="text" name="enter" class="enter" value="" id="lolz"/>
    <input type="button" value="sendws" onclick="ts.sendws();"/>
    <input type="button" value="clear" onclick="ts.cleartimeseq();"/>
    <input type="button" value=">>" onclick="expscaleperunit*=2;"/>
    <input type="button" value="<<" onclick="expscaleperunit/=2;"/>
    <input type="button" value="pause" onclick="bpause=!bpause;"/>
    <select id="channelselect">
        <option>ms5611,200</option>
        <option>ms5611,50</option>
        <option>pulse,35,50</option>
    </select>
</div>

</body>
</html>

